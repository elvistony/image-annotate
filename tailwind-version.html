<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple Image Labelling Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="h-full bg-gray-50">
  <!-- Top Bar -->
  <div class="fixed top-0 left-0 right-0 h-12 bg-white shadow z-20 flex justify-between items-center px-4">
    <div class="text-xl font-semibold">Simple Labelling Tool  
        <span class="text-sm pl-4">
            <input class="" type="text" style="width: 200px;" id="project-name" value="very-wild-project" id="">.limg
            <i class="fa fa-pencil"></i>
        </span>
    </div>
    <div class="flex gap-2">
      <input type="file" accept=".limg" id="projectImport" class="hidden" />
      <input type="file" accept="image/*" id="newImageInput" class="hidden" />
      <button onclick="document.getElementById('projectImport').click()" class="px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" ><i class="fa fa-upload"></i> Import .limg</button>
      <button onclick="newProject()" class="px-4 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700" title="New Labelled Image"><i class="fa fa-plus"></i> New</button>
      <button onclick="saveProject()" class="px-4 py-1 bg-green-500 text-white rounded hover:bg-green-600"><i class="fa fa-download"></i> Download</button>
    </div>
  </div>
 
  <!-- Left Toolbar -->
  <div class="fixed top-12 left-0 bottom-0 w-16 bg-white shadow flex flex-col items-center py-4 space-y-4 z-20">
    <button id="opt-pan" onclick="setTool('pan')" class="tool-button" title="Mouse Pointer"><i class="fa fa-mouse-pointer"></i></button>
    <button id="opt-annotate" onclick="setTool('annotate')" class="tool-button active" title="Annotate"><i class="fa fa-map-marker"></i></button>
  </div>
 
  <!-- Right Sidebar for Annotation Cards -->
  <div class="fixed top-12 right-0 bottom-0 bg-white shadow overflow-y-auto p-4 z-20 " style="width: 20%;" >
    <h4 class="text-center text-lg font-bold">Labels</h4>
    <div class="w-full space-y-4" id="annotationList">
 
    </div>
  </div>
 
  <!-- Main Canvas Area -->
  <div class="absolute top-12 left-16 bottom-0 overflow-hidden">
    <div id="canvasContainer" class="w-full h-full relative flex items-center justify-center">
      <div class="relative" id="imageWrapper">
        <canvas id="imageCanvas" class="block"></canvas>
        <div id="markerOverlay" class="absolute top-0 left-0 z-30 pointer-events-none"></div>
      </div>
    </div>
  </div>
  <style>
    .tool-button {
      @apply w-10 h-10 flex items-center justify-center bg-gray-100 rounded hover:bg-gray-200 cursor-pointer text-lg;
        padding: 15px;
        transition: 0.2s ease;
        border-radius: 5px;
    }
    .tool-button:hover{
        background: lightgray;
    }
    .tool-button.active{
        border: 1px solid gray;
    }
    .annotation-marker:hover{
        opacity: 1;
    }
    .annotation-marker {
      background-color: #1873c9;
      opacity: 0.5;
      color: white;
      cursor: pointer;
      height: 30px;
      width: 30px;
      text-align: center;
      position: absolute;
      border-radius: 50%;
      border-color: white;
      border-width: 3px;
      transition: 0.2s ease;
      @apply absolute flex items-center justify-center text-white text-[10px] font-bold z-30;
    }
    .annotation-marker.active {
      background-color: orange;
      opacity: 1;
    }
    .annotation-card {
      border: 2px solid lightgray;
      border-radius: 5px;
      padding: 15px;
      cursor: pointer;
      background-color: #f7f7f7;
      @apply border-l-4 border-blue-500 bg-gray-50 shadow rounded space-y-1;
    }
    .annotation-card div {
      font-size: 20px;
    }
    .annotation-card > .textarea-container{
        width: 100%;
        background-color: white;
        padding: 0px 10px;
        border-radius: 5px;
        border: 1px solid lightgray;
    }
    .annotation-card textarea {
      @apply w-100 resize-none border rounded p-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400;
        width: 100%;
        background: white;
        outline: none;
        border: none;
    }
    .annotation-card.active{
        background-color: #fffbe4;
    }
  </style>
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    let currentTool = 'annotate';
    let annotationCounter = 1;
    let annotations = [];
    let historyStack = [];
    let redoStack = [];
    let currentImageFileName = "";
    let scale = 1;
    let img = new Image();
    let selectedAnnotationId = null;
 
    function setTool(tool) {
      currentTool = tool;
      document.querySelector('.tool-button.active').classList.remove('active')
      document.querySelector('#opt-'+tool).classList.add('active')
    }
 
    function saveToHistory() {
      historyStack.push(JSON.stringify(annotations));
      redoStack = [];
    }
 
    function undo() {
      if (historyStack.length === 0) return;
      redoStack.push(JSON.stringify(annotations));
      annotations = JSON.parse(historyStack.pop());
      annotationCounter = annotations.length + 1;
      renderAnnotations();
    }
 
    function redo() {
      if (redoStack.length === 0) return;
      historyStack.push(JSON.stringify(annotations));
      annotations = JSON.parse(redoStack.pop());
      annotationCounter = annotations.length + 1;
      renderAnnotations();
    }
 
    function newProject() {
      document.getElementById('newImageInput').click();
    //   document.getElementById('intro').style.display='none';
    }
 
    function drawImageOnCanvas() {
      const canvas = document.getElementById('imageCanvas');
      const ctx = canvas.getContext('2d');
      const maxWidth = window.innerWidth * 0.8;
      const maxHeight = window.innerHeight * 0.9;
      scale = Math.min(maxWidth / img.width, maxHeight / img.height);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      renderAnnotations();
    }
 
    const randomWords = ["victory","smiling","snuggle","rabbit","overload","downhill","portrayal","twine","modernist","outlet","amount","nitrate","gridlock","jovial","party","protagonist","second","degree","swallow","empire","relapse"]
    const projectName = randomWords[Math.floor(Math.random() * randomWords.length)]+'-'+randomWords[Math.floor(Math.random() * randomWords.length)]+'-'+randomWords[Math.floor(Math.random() * randomWords.length)];
    document.getElementById('project-name').value = projectName

    document.getElementById('newImageInput').addEventListener('change', (e) => {
     
      const file = e.target.files[0];
      if (!file) return;
      currentImageFileName = file.name;
      const reader = new FileReader();
      reader.onload = () => {
        img.onload = () => {
          annotations = [];
          annotationCounter = 1;
          historyStack = [];
          redoStack = [];
          drawImageOnCanvas();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
 
    function saveProject() {
      const zip = new JSZip();
      fetch(img.src)
        .then(res => res.blob())
        .then(blob => {
          zip.file(currentImageFileName, blob);
          zip.file('label.json', JSON.stringify({
            image: { filename: currentImageFileName },
            labels: annotations
          }, null, 2));
          zip.generateAsync({ type: 'blob' }).then(content => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = (document.getElementById('project-name').value || "project")+'.limg';
            a.click();
          });
        });
    }
 
    function renderAnnotations() {
      const overlay = document.getElementById('markerOverlay');
      const list = document.getElementById('annotationList');
      overlay.innerHTML = '';
      list.innerHTML = '';
      overlay.style.width = `${img.width * scale}px`;
      overlay.style.height = `${img.height * scale}px`;
 
      annotations.forEach((ann, index) => {
        const marker = document.createElement('div');
        marker.className = 'annotation-marker pointer-events-auto';
        marker.style.left = `${ann.x * scale - 15}px`;
        marker.style.top = `${ann.y * scale - 15}px`;
        marker.textContent = index + 1;
        marker.dataset.id = ann.id;
        if (selectedAnnotationId === ann.id) marker.classList.add('active');
        marker.onclick = () => {
          selectedAnnotationId = ann.id;
          renderAnnotations();
        };
        overlay.appendChild(marker);
 
        const card = document.createElement('div');
        card.className = `annotation-card ${(selectedAnnotationId === ann.id)?"active":""}`;
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="text-md font-bold">#${index + 1}</span>
            <button onclick="deleteAnnotation(${ann.id})" class="text-red-500"><i class="fa fa-trash"></i></button>
          </div>
          <div class="textarea-container">
            <textarea data-id="${ann.id}">${ann.desc}</textarea>
          </div>
        `;
 
 
        card.onclick = () => {
        if(event.target.tagName!='TEXTAREA'){
            selectedAnnotationId = ann.id;
          renderAnnotations();
          console.log()
        }
         
        };
        const textarea = card.querySelector('textarea');
        textarea.addEventListener('focus', () => {
          selectedAnnotationId = ann.id;
        //   renderAnnotations();
        });
        textarea.addEventListener('input', (e) => {
          ann.desc = e.target.value;
        });
 
        list.appendChild(card);
      });
    }
 
    function deleteAnnotation(id) {
      saveToHistory();
      annotations = annotations.filter(a => a.id !== id);
      annotationCounter = annotations.length + 1;
      selectedAnnotationId = null;
      renderAnnotations();
    }
 
    document.getElementById('imageCanvas').addEventListener('click', (e) => {
      if (currentTool !== 'annotate') return;
      const rect = e.target.getBoundingClientRect();
      const x = (e.clientX - rect.left) / scale;
      const y = (e.clientY - rect.top) / scale;
 
      saveToHistory();
 
      annotations.push({ id: Date.now(), x, y, desc: 'Description here' });
      annotationCounter++;
      renderAnnotations();
    });
 
    document.getElementById('projectImport').addEventListener('change', async (e) => {
      const file = e.target.files[0];
    //   document.getElementById('intro').style.display='none';
      if (!file || !file.name.endsWith('.limg')) return;
      document.getElementById('project-name').value = file.name.replace('.limg','');
      const zip = await JSZip.loadAsync(file);
      const jsonStr = await zip.file('label.json').async('string');
      const data = JSON.parse(jsonStr);
      const imgBlob = await zip.file(data.image.filename).async('blob');
 
      currentImageFileName = data.image.filename;
      annotations = data.labels;
      annotationCounter = annotations.length + 1;
 
      img.onload = () => {
        drawImageOnCanvas();
      };
      img.src = URL.createObjectURL(imgBlob);
    });
 
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveProject();
      }
      if (e.ctrlKey && e.key === 'z') {
        e.preventDefault();
        undo();
      }
      if (e.ctrlKey && e.key === 'y') {
        e.preventDefault();
        redo();
      }
      if (e.key === 'Delete' && selectedAnnotationId !== null) {
        deleteAnnotation(selectedAnnotationId);
      }
    });
  </script>
</body>
</html>
 
